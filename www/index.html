<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Mosquitto Websockets</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="mqttws31.js" type="text/javascript"></script>
    <script src="jquery.min.js" type="text/javascript"></script>
    <script src="config.js" type="text/javascript"></script>
    
  </head>
  <body>
    <h1>Jarno Mattila (t5maja03) </h1>
    <h2>Embedded Systems Development Project 5N00BH73 Autumn 2017 </h2>
    <div>
        
        <p id='ws' style="font-family: 'Courier New', Courier, monospace;"></p>
    </div>
    <div id="chartContainer" style="height: 400px; width: 100%;"></div>
   
   <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    <script type="text/javascript">
      var data = {celsius:[], farenheit:[] };
      var avg;
     
     var chart = new CanvasJS.Chart("chartContainer", {
         animationEnabled: true,  
         title:{
            text: "Temperature (last 1 min.)"
         },
          
         axisY: {
            title: "Temp",
            
            suffix: "C",
            stripLines: [{
               value: parseFloat(avg),
               label: "Average:"
            }]
         },
         axisX:{
            title: "Time",
            valueFormatString: "H:mm:ss",
            labelFontSize: 10,
            labelAngle: 0,
            
         },
         data: [{
           
            type: "spline",
            dataPoints: data.celsius
         }]
         
      });
      //chart.render();
   
      

      
       
       
    var mqtt;
    var reconnectTimeout = 2000;
    

    function MQTTconnect() {
	if (typeof path == "undefined") {
		path = '/mqtt';
	}
	mqtt = new Paho.MQTT.Client(
			host,
			port,
			path,
			"web_" + parseInt(Math.random() * 100, 10)
	);
        var options = {
            timeout: 3,
            useSSL: useTLS,
            cleanSession: cleansession,
            onSuccess: onConnect,
            onFailure: function (message) {
                $('#status').val("Connection failed: " + message.errorMessage + "Retrying");
                setTimeout(MQTTconnect, reconnectTimeout);
            }
        };

        mqtt.onConnectionLost = onConnectionLost;
        mqtt.onMessageArrived = onMessageArrived;

        if (username != null) {
            options.userName = username;
            options.password = password;
        }
        //console.log("Host="+ host + ", port=" + port + ", path=" + path + " TLS = " + useTLS + " username=" + username + " password=" + password);
        mqtt.connect(options);
    }

    function onConnect() {
        $('#status').val('Connected to ' + host + ':' + port + path);
        // Connection succeeded; subscribe to our topic
        mqtt.subscribe(topic, {qos: 0});
        $('#topic').val(topic);
    }

    function onConnectionLost(response) {
        setTimeout(MQTTconnect, reconnectTimeout);
        //$('#status').val("connection lost: " + responseObject.errorMessage + ". Reconnecting");

    };
      var counter = 1;
    function onMessageArrived(message) {

        var topic = message.destinationName;
        var payload = message.payloadString;
        var timestamp = new Date();
        
        var jsonObj = JSON.parse(payload);
        data.celsius.push({x:timestamp, y:parseFloat(jsonObj.c)});
        if(data.celsius.lenght > 60)data.celsius.splice(0,1);
        data.farenheit.push("{\"x\":\""+timestamp+"\", \"y\":\""+jsonObj.f+"\"}");
        

        $('#ws').text('Temperature from RapberryPi Dallas sensor is ' + jsonObj.c );
        
        var total = 0
       $.each(data.celsius, function (i, v) {
           total += v.y;
       });
         avg = total/data.celsius.length;
         console.log(avg);
         chart.options.axisY.stripLines[0].value = avg;
         chart.options.axisY.stripLines[0].label = "avg:"+parseFloat(avg).toFixed(2);
         chart.options.axisX.minimum = data.celsius[0].x;
         console.log(data.celsius[0].x);
         chart.render();
    };


    $(document).ready(function() {
        MQTTconnect();
    });


    
    </script>
  </body>
</html>
